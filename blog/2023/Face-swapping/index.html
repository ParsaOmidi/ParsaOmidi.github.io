<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Face swapping between two images | Parsa Omidi</title> <meta name="author" content="Parsa Omidi"> <meta name="description" content="Using statistical methods to perform sentiment analysis on a dataset of reviews might be simpler than you think."> <meta name="keywords" content="machine-learning, data-science, ai"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://parsaomidi.github.io/blog/2023/Face-swapping/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Parsa </span>Omidi</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Face swapping between two images</h1> <p class="post-meta">January 15, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/machinevision"> <i class="fas fa-hashtag fa-sm"></i> MachineVision</a>   <a href="/blog/tag/opencv"> <i class="fas fa-hashtag fa-sm"></i> OpenCV</a>   <a href="/blog/tag/python"> <i class="fas fa-hashtag fa-sm"></i> Python</a>   </p> </header> <article class="post-content"> <p>This is a Python script that makes use of the OpenCV and dlib libraries to perform face swapping between two images. The script reads in two images, finds the facial landmarks on each image using dlib or OpenCV’s Haar cascades, aligns the faces using Procrustes analysis, and finally swaps the faces by blending the two images together.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td> <td class="code"><pre><span class="c1"># Import necessary libraries
</span><span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">dlib</span>
<span class="kn">import</span> <span class="n">numpy</span>
<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="c1"># Pretrained model that predicts facial feature rectangles
</span><span class="n">PREDICTOR_PATH</span> <span class="o">=</span> <span class="s">"shape_predictor_68_face_landmarks.dat"</span>
<span class="n">SCALE_FACTOR</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FEATHER_AMOUNT</span> <span class="o">=</span> <span class="mi">11</span>

<span class="c1"># Define different facial feature points for later use
</span><span class="n">FACE_POINTS</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">68</span><span class="p">))</span>
<span class="n">MOUTH_POINTS</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">61</span><span class="p">))</span>
<span class="n">RIGHT_BROW_POINTS</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>
<span class="n">LEFT_BROW_POINTS</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">27</span><span class="p">))</span>
<span class="n">RIGHT_EYE_POINTS</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span>
<span class="n">LEFT_EYE_POINTS</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
<span class="n">NOSE_POINTS</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
<span class="n">JAW_POINTS</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span>

<span class="c1"># Points used to align images
</span><span class="n">ALIGN_POINTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">LEFT_BROW_POINTS</span> <span class="o">+</span> <span class="n">RIGHT_EYE_POINTS</span> <span class="o">+</span> <span class="n">LEFT_EYE_POINTS</span> <span class="o">+</span>
                               <span class="n">RIGHT_BROW_POINTS</span> <span class="o">+</span> <span class="n">NOSE_POINTS</span> <span class="o">+</span> <span class="n">MOUTH_POINTS</span><span class="p">)</span>

<span class="c1"># Points from the second image to overlay on the first
</span><span class="n">OVERLAY_POINTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">LEFT_EYE_POINTS</span> <span class="o">+</span> <span class="n">RIGHT_EYE_POINTS</span> <span class="o">+</span> <span class="n">LEFT_BROW_POINTS</span> <span class="o">+</span> <span class="n">RIGHT_BROW_POINTS</span><span class="p">,</span>
    <span class="n">NOSE_POINTS</span> <span class="o">+</span> <span class="n">MOUTH_POINTS</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Amount of blur to use during colour correction, as a fraction of the
# pupillary distance.
</span><span class="n">COLOUR_CORRECT_BLUR_FRAC</span> <span class="o">=</span> <span class="mf">0.6</span>

<span class="c1"># Load the face cascade classifier and the dlib frontal face detector
</span><span class="n">cascade_path</span><span class="o">=</span><span class="s">'Haarcascades/haarcascade_frontalface_default.xml'</span>
<span class="n">cascade</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nc">CascadeClassifier</span><span class="p">(</span><span class="n">cascade_path</span><span class="p">)</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">dlib</span><span class="p">.</span><span class="nf">get_frontal_face_detector</span><span class="p">()</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">dlib</span><span class="p">.</span><span class="nf">shape_predictor</span><span class="p">(</span><span class="n">PREDICTOR_PATH</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_landmarks</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">dlibOn</span><span class="p">):</span>
    <span class="s">"""
    Get facial landmarks from the image using either dlib or OpenCV.

    :param im: Input image to get landmarks from.
    :param dlibOn: Boolean indicating whether to use dlib or OpenCV for facial detection.
    :return: Matrix containing the x and y coordinates of the facial landmarks.
    """</span>
    <span class="c1"># If using dlib, detect facial landmarks using the dlib frontal face detector
</span>    <span class="nf">if </span><span class="p">(</span><span class="n">dlibOn</span> <span class="o">==</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="nf">detector</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"error"</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"error"</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="p">.</span><span class="nf">matrix</span><span class="p">([[</span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">predictor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">rects</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">parts</span><span class="p">()])</span>

    <span class="c1"># Otherwise, use OpenCV to detect facial landmarks
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="n">cascade</span><span class="p">.</span><span class="nf">detectMultiScale</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"error"</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"error"</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span><span class="n">rects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rect</span><span class="o">=</span><span class="n">dlib</span><span class="p">.</span><span class="nf">rectangle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="p">.</span><span class="nf">matrix</span><span class="p">([[</span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">predictor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">rect</span><span class="p">).</span><span class="nf">parts</span><span class="p">()])</span>


<span class="k">def</span> <span class="nf">annotate_landmarks</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">):</span>
    <span class="s">"""
    Annotate facial landmarks on the image.

    :param im: Input image to annotate landmarks on.
    :param landmarks: Matrix containing the x and y coordinates of the facial landmarks.
    :return: Copy of the input image with facial landmarks annotated.
    """</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">landmarks</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">putText</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">pos</span><span class="p">,</span>
                    <span class="n">fontFace</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">FONT</span>
</pre></td> </tr></tbody></table></code></pre></figure> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"ParsaOmidi/parsaomidi.github.io","data-repo-id":"MDEwOlJlcG9zaXRvcnk2MDAyNDM2NQ==","data-category":"Comments","data-category-id":"DIC_kwDOA5PmLc4CTBt6","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,a])=>giscusScript.setAttribute(t,a)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Parsa Omidi. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>